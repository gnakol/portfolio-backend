<div class="visit-tracking-container">
  <!-- Header -->
  <header class="tracking-header">
    <div class="header-content">
      <button mat-icon-button routerLink="/dashboard-admin" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div>
        <h1>üìä Cockpit Analytics</h1>
        <p class="subtitle">Suivi des visites du portfolio</p>
      </div>
    </div>
    <button mat-raised-button color="primary" (click)="exportToCSV()" *ngIf="selectedTab === 'visits'">
      <mat-icon>download</mat-icon>
      Exporter CSV
    </button>
  </header>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-state">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des donn√©es...</p>
  </div>

  <!-- Tabs -->
  <mat-tab-group *ngIf="!isLoading" class="tracking-tabs" (selectedIndexChange)="onTabChange($event)">
    <!-- TAB 1: Vue d'ensemble -->
    <mat-tab label="Vue d'ensemble">
      <div class="tab-content">
        <!-- KPIs -->
        <div class="kpi-grid">
          <mat-card class="kpi-card">
            <mat-card-header>
              <mat-icon>visibility</mat-icon>
              <span>Total Visites</span>
            </mat-card-header>
            <mat-card-content>
              <h2>{{ totalVisits }}</h2>
              <p class="kpi-label">Depuis le d√©but</p>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-icon>schedule</mat-icon>
            <mat-card-header>
              <span>Dur√©e moyenne</span>
            </mat-card-header>
            <mat-card-content>
              <h2>{{ avgSessionDuration }}</h2>
              <p class="kpi-label">Par session</p>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-icon>public</mat-icon>
            <mat-card-header>
              <span>Top Pays</span>
            </mat-card-header>
            <mat-card-content>
              <h2>{{ topCountry }}</h2>
              <p class="kpi-label">Le plus fr√©quent</p>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-icon>devices</mat-icon>
            <mat-card-header>
              <span>Top Device</span>
            </mat-card-header>
            <mat-card-content>
              <h2>{{ topDevice }}</h2>
              <p class="kpi-label">Le plus utilis√©</p>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Visites r√©centes (derni√®res 24h) -->
        <mat-card class="recent-visits-card">
          <mat-card-header>
            <mat-icon>access_time</mat-icon>
            <h3>Visites r√©centes (24h)</h3>
            <span class="badge">{{ recentVisitsCount }}</span>
          </mat-card-header>
          <mat-card-content>
            <div class="visits-table-wrapper" *ngIf="stats?.recentVisits && stats.recentVisits.length > 0">
              <table class="visits-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Page</th>
                    <th>Pays</th>
                    <th>Device</th>
                    <th>Dur√©e</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let visit of stats.recentVisits">
                    <td>{{ formatDate(visit.visitDate) }}</td>
                    <td class="page-url">{{ visit.pageUrl }}</td>
                    <td>{{ visit.country || 'N/A' }}</td>
                    <td>{{ visit.deviceType || 'N/A' }}</td>
                    <td>{{ formatDuration(visit.sessionDuration) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div *ngIf="!stats?.recentVisits || stats.recentVisits.length === 0" class="empty-state">
              <mat-icon>info</mat-icon>
              <p>Aucune visite dans les derni√®res 24h</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- TAB 2: Toutes les visites -->
    <mat-tab label="Toutes les visites">
      <div class="tab-content">
        <!-- Filtres -->
        <mat-card class="filters-card">
          <mat-card-content>
            <div class="filters-grid">
              <mat-form-field appearance="outline">
                <mat-label>Pays</mat-label>
                <input matInput [(ngModel)]="filterCountry" (keyup)="applyFilters()" placeholder="France, USA...">
                <mat-icon matSuffix>public</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Device</mat-label>
                <input matInput [(ngModel)]="filterDevice" (keyup)="applyFilters()" placeholder="Mobile, Desktop...">
                <mat-icon matSuffix>devices</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Page</mat-label>
                <input matInput [(ngModel)]="filterPage" (keyup)="applyFilters()" placeholder="/projets, /cv...">
                <mat-icon matSuffix>link</mat-icon>
              </mat-form-field>

              <button mat-raised-button (click)="resetFilters()">
                <mat-icon>clear</mat-icon>
                Reset
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Table compl√®te -->
        <mat-card class="visits-list-card">
          <mat-card-header>
            <h3>Toutes les visites ({{ filteredVisits.length }})</h3>
          </mat-card-header>
          <mat-card-content>
            <div class="visits-table-wrapper" *ngIf="filteredVisits.length > 0">
              <table class="visits-table full">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Page</th>
                    <th>Pays</th>
                    <th>Device</th>
                    <th>Browser</th>
                    <th>OS</th>
                    <th>Dur√©e</th>
                    <th>Referrer</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let visit of filteredVisits">
                    <td>{{ visit.idVisit }}</td>
                    <td>{{ formatDate(visit.visitDate) }}</td>
                    <td class="page-url">{{ visit.pageUrl }}</td>
                    <td>{{ visit.country || 'N/A' }}</td>
                    <td>{{ visit.deviceType || 'N/A' }}</td>
                    <td>{{ visit.browser || 'N/A' }}</td>
                    <td>{{ visit.operatingSystem || 'N/A' }}</td>
                    <td>{{ formatDuration(visit.sessionDuration) }}</td>
                    <td class="referrer">{{ visit.referrer || 'direct' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div *ngIf="filteredVisits.length === 0" class="empty-state">
              <mat-icon>search_off</mat-icon>
              <p>Aucune visite trouv√©e avec ces filtres</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- TAB 3: Analytics -->
    <mat-tab label="Analytics">
      <div class="tab-content analytics">
        <!-- Visites par pays -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-icon>public</mat-icon>
            <h3>Visites par Pays</h3>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-list" *ngIf="stats?.visitsByCountry && stats.visitsByCountry.length > 0">
              <div class="chart-item" *ngFor="let item of stats.visitsByCountry">
                <span class="label">{{ item.country }}</span>
                <div class="bar-container">
                  <div class="bar" [style.width.%]="(item.count / totalVisits) * 100"></div>
                  <span class="value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Visites par page -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-icon>insert_drive_file</mat-icon>
            <h3>Pages les plus visit√©es</h3>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-list" *ngIf="stats?.visitsByPage && stats.visitsByPage.length > 0">
              <div class="chart-item" *ngFor="let item of stats.visitsByPage">
                <span class="label">{{ item.page }}</span>
                <div class="bar-container">
                  <div class="bar" [style.width.%]="(item.count / totalVisits) * 100"></div>
                  <span class="value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Visites par device -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-icon>devices</mat-icon>
            <h3>Devices</h3>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-list" *ngIf="stats?.visitsByDevice && stats.visitsByDevice.length > 0">
              <div class="chart-item" *ngFor="let item of stats.visitsByDevice">
                <span class="label">{{ item.device }}</span>
                <div class="bar-container">
                  <div class="bar" [style.width.%]="(item.count / totalVisits) * 100"></div>
                  <span class="value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Top referrers -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-icon>link</mat-icon>
            <h3>Top Referrers</h3>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-list" *ngIf="stats?.topReferrers && stats.topReferrers.length > 0">
              <div class="chart-item" *ngFor="let item of stats.topReferrers">
                <span class="label">{{ item.referrer }}</span>
                <div class="bar-container">
                  <div class="bar" [style.width.%]="(item.count / totalVisits) * 100"></div>
                  <span class="value">{{ item.count }}</span>
                </div>
              </div>
            </div>
            <div *ngIf="!stats?.topReferrers || stats.topReferrers.length === 0" class="empty-state">
              <mat-icon>info</mat-icon>
              <p>Aucun referrer externe d√©tect√© (visites directes uniquement)</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
